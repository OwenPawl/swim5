<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Lesson Manager</title>
  <link rel="apple-touch-icon" href="Swimming Person Icon.PNG">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
  <!-- Fonts and Icons -->
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Nunito:wght@600;700;800&display=swap");
    @import url("https://unpkg.com/@phosphor-icons/web@2.1.1/src/css/phosphor.css");

    :root {
      --blue: #007bb4;
      --blue-strong: #006694;
      --green: #00833d;
      --red: #850000;
      --surface: #f7fbff;
      --ink: #0b2a3c;
      --muted: #6b7a86;
      --card: #ffffff;
      --shadow: 0 10px 30px rgba(0, 59, 92, 0.12);
      --radius-lg: 18px;
      --nav-height: 74px;
      --content-bottom-pad: calc(var(--nav-height) + 104px);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      background: radial-gradient(circle at 10% 10%, rgba(0, 123, 180, 0.08), transparent 35%),
                  radial-gradient(circle at 90% 0%, rgba(0, 131, 61, 0.08), transparent 35%),
                  #e9f5ff;
      color: var(--ink);
      font-family: "Nunito", "Arial", "Helvetica", sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 10px;
      padding-bottom: calc(var(--nav-height) + 14px);
      overscroll-behavior-y: contain;
    }

    /* Layout */
    .app-shell {
      width: min(960px, 100%);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Top Bar & Date Controls */
    .top-bar { display: flex; justify-content: center; padding: 8px 10px; }
    
    .date-controls {
      display: inline-flex; align-items: center; gap: 8px;
      background: var(--card); box-shadow: var(--shadow);
      border-radius: 999px; padding: 10px 12px;
    }

    .date-input {
      border: none; font-size: 17px; font-weight: 700; color: var(--ink);
      padding: 8px 10px; border-radius: 12px; background: #f0f6fb; outline: none;
    }

    .icon-btn {
      width: 42px; height: 42px; border-radius: 50%; border: none;
      background: var(--blue); color: white; font-size: 18px; font-weight: 700;
      box-shadow: 0 6px 18px rgba(0, 123, 180, 0.25); cursor: pointer;
      transition: transform 0.1s ease; display: grid; place-items: center;
    }
    .icon-btn:active { transform: scale(0.95); }

    /* Main Content Card */
    .content-card {
      background: var(--card); box-shadow: var(--shadow);
      border-radius: var(--radius-lg); padding: 14px 12px var(--content-bottom-pad);
      min-height: 60vh; position: relative;
    }

    .screen-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .screen-title { font-size: 22px; font-weight: 800; margin: 0; color: var(--ink); }

    /* Tables */
    .table-wrapper {
      background: linear-gradient(180deg, #f5faff, #f0f6fb);
      border-radius: var(--radius-lg); padding: 6px;
      box-shadow: inset 0 0 0 1px rgba(0, 123, 180, 0.05);
      overflow-x: auto;
    }

    .data-table {
      width: 100%; border-collapse: collapse; background: #f9fcff;
      border-radius: 12px; overflow: hidden; table-layout: auto;
    }

    .data-table th, .data-table td {
      padding: 12px 10px; text-align: left; font-size: 15px;
      border-bottom: 1px solid rgba(0, 123, 180, 0.08); vertical-align: middle;
      line-height: 1.3;
    }
    .data-table th { font-weight: 800; color: var(--muted); font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }
    .data-table tr:last-child td { border-bottom: none; }
    
    /* Column Sizing */
    .col-time { width: 1%; white-space: nowrap; }
    .col-dur { width: 1%; white-space: nowrap; text-align: center; color: var(--muted); font-weight: 700;}
    .col-main { max-width: 50vw; overflow: hidden; }
    .name-text { font-weight: 800; color: var(--blue); display: block; }
    .sub-text { font-size: 0.9em; color: var(--muted); display: block; margin-top: 2px; }

    /* Buttons & Inputs */
    .cta, .ghost {
      border: none; border-radius: 14px; padding: 14px 16px;
      font-size: 16px; font-weight: 800; cursor: pointer;
      transition: transform 0.1s ease;
    }
    .cta { background: linear-gradient(145deg, var(--blue), var(--blue-strong)); color: #fff; box-shadow: 0 6px 20px rgba(0,123,180,0.3); }
    .cta:active, .ghost:active { transform: scale(0.98); }
    
    .check-in-btn {
      width: 94px; height: 40px; border-radius: 10px; border: none;
      font-weight: 800; font-size: 14px; color: white; cursor: pointer;
      transition: all 0.2s; margin: 2px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .status-registered { background-color: var(--green); }
    .status-completed { background-color: var(--green); opacity: 0.8; }
    .status-noshow { background-color: var(--red); }
    .note-btn { background-color: var(--blue); width: auto; padding: 0 16px; }

    /* Navigation */
    .bottom-nav {
      position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
      width: min(960px, 100%); height: var(--nav-height);
      background: var(--card); border-radius: 18px 18px 0 0;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
      display: grid; grid-template-columns: 1fr 1fr; padding: 0 12px; z-index: 100;
    }
    .nav-btn {
      background: none; border: none; color: var(--muted);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      gap: 4px; font-weight: 700; font-size: 12px; cursor: pointer;
    }
    .nav-btn i { font-size: 24px; margin-bottom: 2px; }
    .nav-btn.active { color: var(--blue); }

    /* Floating Action Bar (Attendance) */
    .floating-actions {
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: calc(var(--nav-height) + 12px);
      width: min(940px, calc(100% - 20px));
      display: flex; gap: 10px; z-index: 90;
      transition: transform 0.3s ease;
    }
    .floating-actions.hidden { transform: translate(-50%, 150%); }
    .floating-actions input { flex: 1; height: 50px; }
    .btn-submit { background: var(--green); color: white; }
    .btn-reset { background: white; color: var(--blue-strong); border: 1px solid rgba(0,123,180,0.2); }

    /* Utilities */
    .badge-new {
      display: inline-block; padding: 2px 6px; font-size: 10px; font-weight: 800;
      color: var(--green); background: rgba(0, 131, 61, 0.1); border-radius: 4px;
      margin-left: 6px; vertical-align: middle; border: 1px solid rgba(0,131,61,0.2);
    }
    .hidden { display: none !important; }
    .pull-indicator {
      position: fixed; top: 10px; left: 50%; transform: translate(-50%, -150%);
      background: var(--blue); color: white; padding: 8px 16px; border-radius: 20px;
      font-weight: 700; font-size: 14px; z-index: 200; transition: transform 0.2s;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .pull-visible { transform: translate(-50%, 20px); }

    /* Mobile Optimization */
    @media (max-width: 520px) {
      .app-shell { gap: 8px; }
      .content-card { padding: 12px 8px 120px; }
      .data-table th, .data-table td { padding: 10px 6px; font-size: 14px; }
      .check-in-btn { width: 80px; font-size: 13px; }
    }
  </style>
</head>
<body>

  <div class="pull-indicator" id="pullIndicator">Release to refresh</div>

  <div class="app-shell">
    <!-- Header -->
    <header class="top-bar">
      <div class="date-controls">
        <button class="icon-btn" id="prevDate"><i class="ph-bold ph-arrow-left"></i></button>
        <input class="date-input" id="dateInput" type="date">
        <button class="icon-btn" id="nextDate"><i class="ph-bold ph-arrow-right"></i></button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="content-card">
      <div class="screen-header">
        <h2 class="screen-title" id="pageTitle">Schedule</h2>
        <div id="loadingSpinner" class="hidden"><i class="ph-duotone ph-spinner ph-spin"></i></div>
      </div>

      <div class="table-wrapper">
        <table class="data-table" id="mainTable">
          <!-- Content injected by JS -->
        </table>
      </div>
    </main>
  </div>

  <!-- Attendance Actions (Floating) -->
  <div class="floating-actions hidden" id="attendanceActions">
    <input class="cta btn-submit" type="button" value="Submit Attendance" id="btnSubmit">
    <input class="ghost btn-reset" type="button" value="Reset View" id="btnReset">
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <button class="nav-btn active" data-view="schedule">
      <i class="ph-fill ph-calendar-check"></i>
      <span>Schedule</span>
    </button>
    <button class="nav-btn" data-view="attendance">
      <i class="ph-fill ph-clipboard-check"></i>
      <span>Attendance</span>
    </button>
  </nav>

  <!-- Application Logic -->
  <script>
    // --- Configuration & Constants ---
    const CONFIG = {
      clientId: "ixG6UsN5JaLPYFgwjhTAtmdg8UNU7IZYK2lOxTo3",
      ignoredClientIds: [11485475, 11559838, 13602611, 13167161],
      apiBase: "https://mcdonaldswimschool.pike13.com/api/v2/desk",
      reportApi: "https://mcdonaldswimschool.pike13.com/desk/api/v3/reports/clients/queries"
    };

    // --- State Management ---
    const Store = {
      currentDate: new Date().toLocaleDateString('en-CA'),
      currentView: 'schedule', // 'schedule' or 'attendance'
      staffId: localStorage.getItem("staff_id"),
      accessToken: localStorage.getItem("access_token"),
      scheduleData: [], // Raw data from API
      isLoading: false
    };

    // --- Auth & Initialization Module ---
    const Auth = {
      init() {
        // 1. Check URL hash for token (return from OAuth)
        if (window.location.hash.includes("access_token")) {
          const token = window.location.hash.substring(14, 54);
          localStorage.setItem("access_token", token);
          window.history.replaceState(null, null, window.location.pathname);
          Store.accessToken = token;
        }

        // 2. Redirect if no token
        if (!Store.accessToken) {
          window.location.href = `https://pike13.com/oauth/authorize?client_id=${CONFIG.clientId}&response_type=token&redirect_uri=${window.location.href}`;
          return;
        }

        // 3. Fetch Staff ID if missing
        if (!Store.staffId) {
          API.fetchStaffId().then(id => {
            Store.staffId = id;
            localStorage.setItem("staff_id", id);
            App.loadData();
          });
        } else {
          App.loadData();
        }
      }
    };

    // --- API Module ---
    const API = {
      getHeaders() {
        return {
          "Authorization": `Bearer ${Store.accessToken}`,
          "Content-Type": "application/json"
        };
      },

      async fetchStaffId() {
        const res = await fetch(`${CONFIG.apiBase}/staff_members/me`, { headers: this.getHeaders() });
        const json = await res.json();
        return json.staff_members?.[0]?.id;
      },

      async getEvents(date) {
        if (!Store.staffId) return [];
        const midnight = "00:00:00";
        
        try {
          // Parallel fetch: Events & Available Times
          const [eventsRes, opensRes] = await Promise.all([
            fetch(`${CONFIG.apiBase}/event_occurrences.json?from=${date}T${midnight}Z&staff_member_ids=${Store.staffId}`, { headers: this.getHeaders() }),
            fetch(`${CONFIG.apiBase}/available_times.json?from=${date}T${midnight}Z`, { headers: this.getHeaders() })
          ]);

          const eventsData = await eventsRes.json();
          const opensData = await opensRes.json();

          // Step 1: Flatten basic event data
          let rawList = [
            ...(eventsData.event_occurrences || []).flatMap(evt => 
              evt.people.map(p => ({
                id: p.id,
                visitId: p.visit_id,
                state: p.visit_state,
                start: evt.start_at,
                end: evt.end_at,
                name: p.name,
                level: "...", // Placeholder
                isNew: false,
                age: "..."
              }))
            ),
            ...(opensData.available_times || []).filter(open => open.staff_member_id == Store.staffId).map(open => ({
              id: "",
              locationId: open.location_id,
              state: "available",
              start: open.start_at,
              end: open.end_at,
              name: "Open",
              level: "",
              isNew: false,
              age: ""
            }))
          ];

          // Step 2: Enrich with Report Data (Client Details)
          if (rawList.length > 0) {
            const clientIds = rawList.filter(x => x.id).map(x => x.id);
            if (clientIds.length > 0) {
                // Pike13 V3 Reporting Query
                const queryBody = {
                    data: {
                        type: "queries",
                        attributes: {
                            fields: ["person_id", "custom_field_180098", "first_visit_date", "birthdate"],
                            filter: ["or", clientIds.map(id => ["eq", "person_id", String(id)])]
                        }
                    }
                };

                // Note: Using specific bearer for Reports if needed, otherwise fallback to standard
                // The original code used a hardcoded specific token for this call. 
                // Assuming standard token works or re-use existing if valid.
                const reportRes = await fetch(CONFIG.reportApi, {
                    method: "POST",
                    headers: { ...this.getHeaders(), "Authorization": "Bearer kZEbOpElCispz8mFkeoTsVGVCvSP23mZG82G7eeN" }, // Preserved specific token from original
                    body: JSON.stringify(queryBody)
                });

                if (reportRes.ok) {
                    const reportJson = await reportRes.json();
                    const rows = reportJson.data?.attributes?.rows || [];
                    
                    rawList = rawList.map(item => {
                        if (CONFIG.ignoredClientIds.includes(Number(item.id))) return item;
                        
                        const details = rows.find(r => Number(r[0]) === Number(item.id));
                        if (details) {
                            // details[1] = Level (custom field), details[2] = first_visit, details[3] = bday
                            const levelStr = details[1] || "";
                            // Extract single letter level or first word char
                            item.level = /\d/.test(levelStr[6]) ? levelStr[6] : (levelStr.split(" ")[0]?.[0] || "?");
                            item.isNew = !details[2]; // No first visit date = New? Or logic from original
                            
                            if (details[3]) {
                                const diff = Date.now() - new Date(details[3]);
                                item.age = (Math.floor(diff / (31557600000)) * 10 / 10).toFixed(1); // Years
                            }
                        }
                        return item;
                    });
                }
            }
          }
          
          // Sort by time
          return rawList.sort((a, b) => new Date(a.start) - new Date(b.start));

        } catch (err) {
          console.error("Fetch error:", err);
          return [];
        }
      },

      async updateAttendance(updates) {
        const headers = this.getHeaders();
        
        for (const u of updates) {
            // 1. Reset first
            await fetch(`${CONFIG.apiBase}/visits/${u.visitId}`, {
                method: "PUT", headers, body: JSON.stringify({ visit: { state_event: "reset" } })
            });

            // 2. Apply new state (if not reset)
            const targetState = u.type === "Check In" ? "complete" : "noshow";
            
            // Logic: If button says "Check In", it means current state is NOT checked in. 
            // We want to send 'complete'.
            
            await fetch(`${CONFIG.apiBase}/visits/${u.visitId}`, {
                method: "PUT", headers, body: JSON.stringify({ visit: { state_event: targetState } })
            });

            // 3. Punch if No Show
            if (targetState === "noshow") {
                await fetch(`${CONFIG.apiBase}/punches`, {
                    method: "POST", headers, body: JSON.stringify({ punch: { visit_visit_id: u.visitId } }) // Note: API usually wants visit_id
                });
            }
        }
      }
    };

    // --- Logic / Data Processor ---
    const Processor = {
        formatTime(isoString) {
            return new Date(isoString).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', timeZone: 'America/Los_Angeles' });
        },
        
        // Groups consecutive lessons for the same person
        mergeBlocks(data) {
            if (!data || !data.length) return [];
            
            const merged = [];
            for (let i = 0; i < data.length; ) {
                let current = { ...data[i] };
                current.visitors = [{ id: current.id, visitId: current.visitId, state: current.state, name: current.name }];
                
                let j = i + 1;
                // Look ahead for same person, consecutive time
                while (j < data.length && 
                       data[j].id === current.id && 
                       data[j].name === current.name &&
                       new Date(data[j].start).getTime() === new Date(current.end).getTime()) {
                    
                    current.end = data[j].end;
                    current.visitors.push({ id: data[j].id, visitId: data[j].visitId, state: data[j].state, name: data[j].name });
                    j++;
                }
                
                // Format Names
                if (current.state === 'late_canceled' || current.state === 'canceled') {
                    current.displayName = "CANCELED";
                    current.displayLevel = "â€”";
                } else {
                    // Logic to shorten name: "John Doe" -> "John D"
                    const parts = current.name.trim().split(/\s+/);
                    const shortName = parts.length > 1 
                        ? `${parts[0]} ${parts[parts.length-1][0]}` 
                        : parts[0];
                    
                    // Case fix (JOhn -> John)
                    current.displayName = shortName.toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
                }
                
                // Calculate Duration in Minutes
                const duration = (new Date(current.end) - new Date(current.start)) / 60000;
                current.duration = duration;
                current.formattedStart = this.formatTime(current.start);

                merged.push(current);
                i = j;
            }
            return merged;
        },

        // Groups by Start Time for the Table View
        groupByTime(mergedList) {
            const groups = {};
            mergedList.forEach(item => {
                if (!groups[item.start]) groups[item.start] = [];
                groups[item.start].push(item);
            });
            return Object.entries(groups).sort((a, b) => new Date(a[0]) - new Date(b[0]));
        }
    };

    // --- UI Module ---
    const UI = {
        els: {
            table: document.getElementById('mainTable'),
            dateInput: document.getElementById('dateInput'),
            pageTitle: document.getElementById('pageTitle'),
            attendanceActions: document.getElementById('attendanceActions'),
            spinner: document.getElementById('loadingSpinner'),
            navBtns: document.querySelectorAll('.nav-btn')
        },

        render() {
            this.updateNav();
            this.els.attendanceActions.classList.toggle('hidden', Store.currentView !== 'attendance');
            
            if (Store.isLoading) {
                this.els.table.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 30px;">Loading...</td></tr>';
                this.els.spinner.classList.remove('hidden');
                return;
            }
            this.els.spinner.classList.add('hidden');

            const processed = Processor.mergeBlocks(Store.scheduleData);
            
            if (processed.length === 0) {
                this.els.table.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 30px; color: var(--muted);">No lessons scheduled.</td></tr>';
                return;
            }

            // Filter ignored IDs
            const validData = processed.filter(d => !CONFIG.ignoredClientIds.includes(Number(d.id)));
            const groups = Processor.groupByTime(validData);

            if (Store.currentView === 'schedule') {
                this.renderSchedule(groups);
            } else {
                this.renderAttendance(validData); // Attendance is flat list
            }
        },

        renderSchedule(groups) {
            this.els.pageTitle.textContent = "Schedule";
            let html = `<thead><tr><th class="col-time">Start</th><th class="col-dur">Min</th><th class="col-main">Student</th><th>Lvl</th><th>Age</th></tr></thead><tbody>`;

            groups.forEach(([startIso, items]) => {
                const timeStr = Processor.formatTime(startIso).replace(/ AM| PM/,''); // Brief time
                // Assuming identical duration for items in same slot, else take first
                const duration = items[0].duration;
                
                let nameHtml = items.map(i => {
                    let n = `<span class="name-text">${i.displayName} ${i.isNew ? '<span class="badge-new">NEW</span>' : ''}</span>`;
                    return n;
                }).join('<div style="height:8px"></div>'); // Spacer

                let lvlHtml = items.map(i => i.level || '-').join('<br>');
                let ageHtml = items.map(i => i.age || '-').join('<br>');

                html += `
                    <tr>
                        <td class="col-time"><b>${timeStr}</b></td>
                        <td class="col-dur">${duration}</td>
                        <td class="col-main">${nameHtml}</td>
                        <td>${lvlHtml}</td>
                        <td>${ageHtml}</td>
                    </tr>
                `;
            });
            html += "</tbody>";
            this.els.table.innerHTML = html;
        },

        renderAttendance(items) {
            this.els.pageTitle.textContent = "Attendance";
            let html = `<thead><tr><th class="col-main">Student</th><th>Check In / Status</th><th>Notes</th></tr></thead><tbody>`;

            items.forEach(item => {
                // Determine overall color based on first visit status
                const firstState = item.visitors[0].state;
                const color = firstState === 'noshowed' ? 'var(--red)' : (firstState === 'completed' ? 'var(--green)' : 'var(--blue)');

                let checkinButtons = item.visitors.map(v => {
                    const isNoShow = v.state === 'noshowed';
                    const isComplete = v.state === 'completed';
                    const btnClass = isNoShow ? 'status-noshow' : (isComplete ? 'status-completed' : 'status-registered');
                    const btnText = isNoShow ? 'No Show' : 'Check In';
                    const nextState = btnText; // If text is Check In, clicking makes it complete.

                    return `<button class="check-in-btn ${btnClass}" 
                            data-visit-id="${v.visitId}" 
                            data-current-state="${v.state}"
                            onclick="App.toggleCheckIn(this)">${btnText}</button>`;
                }).join('<br>');

                html += `
                    <tr>
                        <td class="col-main">
                            <span class="name-text" style="color:${color}">${item.displayName}</span>
                            <span class="sub-text">${item.formattedStart} (${item.duration}m)</span>
                        </td>
                        <td>${checkinButtons}</td>
                        <td>
                            <button class="check-in-btn note-btn" onclick="location.href='https://mcdonaldswimschool.pike13.com/people/${item.id}/notes'">Notes</button>
                        </td>
                    </tr>
                `;
            });
            html += "</tbody>";
            this.els.table.innerHTML = html;
        },

        updateNav() {
            this.els.navBtns.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === Store.currentView);
            });
        }
    };

    // --- Main Controller ---
    const App = {
        init() {
            // 1. Initialize UI Inputs
            UI.els.dateInput.value = Store.currentDate;
            
            // 2. Event Listeners
            UI.els.dateInput.addEventListener('change', (e) => this.handleDateChange(e.target.value));
            
            document.getElementById('prevDate').addEventListener('click', () => this.offsetDate(-1));
            document.getElementById('nextDate').addEventListener('click', () => this.offsetDate(1));

            UI.els.navBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    Store.currentView = btn.dataset.view;
                    UI.render();
                });
            });

            // Attendance Buttons
            document.getElementById('btnSubmit').addEventListener('click', this.submitAttendance);
            document.getElementById('btnReset').addEventListener('click', this.resetView);

            // 3. Start Auth Flow
            Auth.init();
            
            // 4. Setup Pull to Refresh
            this.setupPullRefresh();
        },

        async loadData() {
            Store.isLoading = true;
            UI.render();
            Store.scheduleData = await API.getEvents(Store.currentDate);
            Store.isLoading = false;
            UI.render();
        },

        handleDateChange(newDate) {
            Store.currentDate = newDate;
            this.loadData();
        },

        offsetDate(days) {
            const d = new Date(Store.currentDate + "T00:00:00");
            d.setDate(d.getDate() + days);
            const newDate = d.toISOString().split('T')[0];
            UI.els.dateInput.value = newDate;
            this.handleDateChange(newDate);
        },

        toggleCheckIn(btn) {
            // Optimistic UI update
            const isCheckIn = btn.innerText === "Check In";
            if (isCheckIn) {
                btn.innerText = "No Show";
                btn.style.backgroundColor = "var(--red)";
                btn.dataset.type = "No Show"; // Tag for submission
            } else {
                btn.innerText = "Check In";
                btn.style.backgroundColor = "var(--green)";
                btn.dataset.type = "Check In";
            }
        },

        async submitAttendance() {
            const btns = [...document.querySelectorAll('.check-in-btn[data-type]')];
            const updates = btns.map(b => ({
                visitId: b.dataset.visitId,
                type: b.dataset.type
            }));

            if (updates.length === 0) return;

            UI.els.table.innerHTML = '<tr><td colspan="3" style="text-align:center">Submitting...</td></tr>';
            
            // In a real app, we'd use Promise.all in API module
            // Using specific date check logic from original
            const selectedDate = new Date(Store.currentDate);
            if (new Date() < selectedDate) {
                alert("Cannot submit attendance for future dates.");
                App.loadData();
                return;
            }

            await API.updateAttendance(updates);
            
            // Refresh
            setTimeout(() => App.loadData(), 500);
        },
        
        resetView() {
             App.loadData(); // Just re-fetch/re-render
        },

        setupPullRefresh() {
            let startY = 0;
            let armed = false;
            const indicator = document.getElementById('pullIndicator');
            
            window.addEventListener('touchstart', e => {
                if (window.scrollY === 0) {
                    startY = e.touches[0].clientY;
                    armed = true;
                }
            }, {passive: true});

            window.addEventListener('touchmove', e => {
                if (!armed) return;
                const delta = e.touches[0].clientY - startY;
                if (delta > 80) {
                    indicator.classList.add('pull-visible');
                } else {
                    indicator.classList.remove('pull-visible');
                }
            }, {passive: true});

            window.addEventListener('touchend', () => {
                if (indicator.classList.contains('pull-visible')) {
                    location.reload();
                }
                armed = false;
                indicator.classList.remove('pull-visible');
            });
        }
    };

    // Boot
    document.addEventListener('DOMContentLoaded', () => App.init());

  </script>
</body>
</html>
